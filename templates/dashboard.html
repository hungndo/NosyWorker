{% set outlook_channel_ids = [] %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NosyWorker Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .slide-panel {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            width: 50%;
            min-width: 640px;
            visibility: hidden;
        }
        .slide-panel.open {
            transform: translateX(0);
            visibility: visible;
            transition: transform 0.3s ease-in-out, visibility 0s;
        }
        .slide-panel.closing {
            transform: translateX(100%);
            visibility: hidden;
            transition: transform 0s, visibility 0s;
        }
        .main-content {
            transition: width 0.3s ease-in-out, margin-right 0.3s ease-in-out;
            width: 100%;
            margin-right: 0;
        }
        .main-content.squeezed {
            width: 50%;
            margin-right: 50%;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="p-6 main-content">
        <div class="max-w-6xl mx-auto space-y-6">
            <!-- Header -->
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">NosyWorker Dashboard</h1>
                    <p class="text-gray-600 mt-1">Your Intelligent Operations Assistant</p>
                </div>
            </div>

            <!-- Channel Management -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold">Communication Channels</h2>
                            <p class="text-gray-600 mt-1">Select which Outlook emails and Slack channels to monitor and summarize</p>
                        </div>
                        <button class="px-4 py-2 border rounded-md text-sm flex items-center gap-2 hover:bg-gray-50">
                            <i data-feather="plus" class="h-4 w-4"></i>
                            Add Channel
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for channel in channels %}
                        {% if channel.type == "outlook" %}{% set _ = outlook_channel_ids.append(channel.id) %}{% endif %}
                        <div class="flex items-center justify-between p-4 border rounded-lg">
                            <div class="flex items-center gap-3">
                                <button onclick="openChannelPanel('{{ channel.id }}')" class="flex items-center gap-4 text-left hover:opacity-75 transition-opacity">
                                    <div class="flex items-center gap-3">
                                        {% if channel.type == "outlook" %}
                                        <i data-feather="mail" class="h-5 w-5 text-blue-600"></i>
                                        {% else %}
                                        <i data-feather="message-square" class="h-5 w-5 text-green-600"></i>
                                        {% endif %}
                                        <div>
                                            <p class="font-medium flex items-center gap-2">
                                              {{ channel.name }}
                                            </p>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="px-2 py-1 text-xs rounded-full {% if channel.type == 'outlook' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                                                    {{ channel.type|title }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </button>
                                {% if channel.type == "outlook" %}
                                <span id="auth-status-{{ channel.id }}" class="ml-2 cursor-pointer" style="position: relative;"></span>
                                <button id="auth-btn-{{ channel.id }}" class="ml-2 px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600 hidden" onclick="authenticateOutlook(event, '{{ channel.id }}')">Authenticate</button>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded-md flex items-center gap-2" onclick="openProfileDialog('{{ channel.id }}', event)">
                                    <i data-feather="edit-3" class="h-4 w-4"></i>
                                    {{ "Edit Profile" if channel.profile else "Set Profile" }}
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Client-Organized Action Items Section -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold">Client Action Items</h2>
                            <p class="text-gray-600 mt-1">Action items organized by client with priority and category breakdown</p>
                        </div>
                        <button onclick="refreshClientActionItems()" class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm flex items-center gap-2 hover:bg-purple-700">
                            <i data-feather="refresh-cw" class="h-4 w-4"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="clientActionItemsContainer" class="space-y-6">
                        <div class="flex items-center justify-center py-8">
                            <div class="text-center">
                                <i data-feather="loader" class="h-8 w-8 text-gray-400 mx-auto mb-2 animate-spin"></i>
                                <p class="text-gray-500">Loading client action items...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Items Section -->
            {#
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold">Customer Success Action Items</h2>
                            <p class="text-gray-600 mt-1">Actionable items generated from meeting summaries to improve client satisfaction</p>
                        </div>
                        <button onclick="refreshActionItems()" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm flex items-center gap-2 hover:bg-blue-700">
                            <i data-feather="refresh-cw" class="h-4 w-4"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="actionItemsContainer" class="space-y-6">
                        <div class="flex items-center justify-center py-8">
                            <div class="text-center">
                                <i data-feather="loader" class="h-8 w-8 text-gray-400 mx-auto mb-2 animate-spin"></i>
                                <p class="text-gray-500">Loading action items...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            #}
        </div>
    </div>

    <!-- Sliding Panel -->
    <div id="channelPanel" class="slide-panel fixed top-0 right-0 h-full bg-white shadow-xl z-50">
        <div class="h-full flex flex-col">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold" id="panelTitle">Channel Details</h3>
                    <button type="button" onclick="closeChannelPanel()" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                        <i data-feather="x" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="p-6">
                    <div id="panelContent">
                        <!-- Content will be dynamically populated -->
                    </div>
                    <div class="mt-6">
                        <h4 class="text-lg font-medium mb-4">Summarize Channel Activity</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time Range</label>
                                <select id="timeRange" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="1h">Last Hour</option>
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div id="customDateRange" class="hidden space-y-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="datetime-local" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                                    <input type="datetime-local" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                            <button onclick="summarizeChannel()" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center gap-2">
                                <i data-feather="activity" class="h-4 w-4"></i>
                                Summarize Activity
                            </button>
                            <div id="summaryContainer" class="hidden">
                                <div class="mt-6 pt-6 border-t">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-medium text-gray-900">Summary</h4>
                                        <button onclick="copySummary()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                                            <i data-feather="copy" class="h-4 w-4"></i>
                                            Copy
                                        </button>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <div id="summaryContent" class="prose prose-sm max-w-none"></div>
                                    </div>
                                    <!-- Save/Dismiss options -->
                                    <div id="saveSummaryOptions" class="mt-4 flex gap-4 hidden">
                                        <button id="saveSummaryBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                            <i data-feather="save" class="h-4 w-4"></i>
                                            Save Summary for Action Generation
                                        </button>
                                        <button id="dismissSummaryBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 flex items-center gap-2">
                                            <i data-feather="x-circle" class="h-4 w-4"></i>
                                            Dismiss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Dialog -->
    <div id="profileDialog" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                    <div class="absolute right-0 top-0 pr-4 pt-4">
                        <button type="button" onclick="closeProfileDialog()" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none">
                            <i data-feather="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="dialogTitle">Edit Channel Profile</h3>
                            <div id="dialogContent" class="space-y-4">
                                <!-- Content will be dynamically populated -->
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" onclick="saveChannelProfile()" class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                            Save Changes
                        </button>
                        <button type="button" onclick="closeProfileDialog()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Action Dialog -->
    <div id="emailActionDialog" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl sm:p-6">
                    <div class="absolute right-0 top-0 pr-4 pt-4">
                        <button type="button" onclick="closeEmailActionDialog()" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none">
                            <i data-feather="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">Take Action - Send Email</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Action Item</label>
                                    <div id="actionItemDisplay" class="bg-gray-50 rounded-md p-3 text-sm text-gray-900"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
                                    <input type="email" id="emailTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="recipient@example.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                                    <input type="text" id="emailSubject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Action Item Follow-up">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                                    <textarea id="emailMessage" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Compose your message here..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" onclick="sendActionEmail()" class="inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:ml-3 sm:w-auto">
                            <i data-feather="send" class="h-4 w-4 mr-2"></i>
                            Send Email
                        </button>
                        <button type="button" onclick="closeEmailActionDialog()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="outlook-channel-ids" type="application/json">{{ outlook_channel_ids|tojson }}</script>
    <script>
        // Initialize Feather icons
        feather.replace();

        let currentChannelId = null;

        // Open channel panel function
        function openChannelPanel(channelId) {
            currentChannelId = channelId;
            const panel = document.getElementById('channelPanel');
            const mainContent = document.querySelector('.main-content');
            panel.classList.remove('closing');
            panel.classList.add('open');
            mainContent.classList.add('squeezed');
            
            // Hide and clear any existing summary
            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.classList.add('hidden');
            document.getElementById('summaryContent').innerHTML = '';
            
            // Fetch channel details and populate panel
            fetch(`/api/channels/${channelId}/profile`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('panelContent');
                    document.getElementById('panelTitle').textContent = `${data.name} Details`;
                    
                    if (data.profile) {
                        content.innerHTML = `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Audience</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3">${data.profile.audience}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Data Sources</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3">${data.profile.dataSources}</textarea>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Audience</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3" placeholder="Describe the target audience..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Data Sources</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3" placeholder="List the data sources..."></textarea>
                                </div>
                            </div>
                        `;
                    }
                    feather.replace();
                });
        }

        // Close channel panel function
        function closeChannelPanel() {
            const panel = document.getElementById('channelPanel');
            const mainContent = document.querySelector('.main-content');
            panel.classList.remove('open');
            panel.classList.add('closing');
            mainContent.classList.remove('squeezed');
            currentChannelId = null;
            
            // Hide and clear the summary
            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.classList.add('hidden');
            document.getElementById('summaryContent').innerHTML = '';
        }

        // Open profile dialog function
        function openProfileDialog(channelId, event) {
            event.stopPropagation(); // Prevent the channel panel from opening
            currentChannelId = channelId;
            const dialog = document.getElementById('profileDialog');
            dialog.classList.remove('hidden');
            
            // Fetch channel details and populate dialog
            fetch(`/api/channels/${channelId}/profile`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('dialogContent');
                    const channel = channels.find(c => c.id === channelId);
                    document.getElementById('dialogTitle').textContent = `Edit ${channel.name} Profile`;
                    
                    if (data.profile) {
                        content.innerHTML = `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Audience</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3">${data.profile.audience}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Data Sources</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3">${data.profile.dataSources}</textarea>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Audience</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3" placeholder="Describe the target audience..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Data Sources</label>
                                    <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" rows="3" placeholder="List the data sources..."></textarea>
                                </div>
                            </div>
                        `;
                    }
                    feather.replace();
                });
        }

        // Close profile dialog function
        function closeProfileDialog() {
            const dialog = document.getElementById('profileDialog');
            dialog.classList.add('hidden');
            currentChannelId = null;
        }

        // Save channel profile function
        function saveChannelProfile() {
            if (!currentChannelId) return;

            const textareas = document.querySelectorAll('#dialogContent textarea');
            const profile = {
                audience: textareas[0].value,
                dataSources: textareas[1].value
            };

            fetch(`/api/channels/${currentChannelId}/profile`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profile)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeProfileDialog();
                    // Refresh the page to update the UI
                    window.location.reload();
                }
            });
        }

        // Handle time range selection
        document.getElementById('timeRange').addEventListener('change', function(e) {
            const customRange = document.getElementById('customDateRange');
            if (e.target.value === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
            }
        });

        // Summarize channel function
        function summarizeChannel() {
            if (!currentChannelId) return;

            const timeRange = document.getElementById('timeRange').value;
            let startTime, endTime;

            if (timeRange === 'custom') {
                startTime = document.getElementById('startDate').value;
                endTime = document.getElementById('endDate').value;
                if (!startTime || !endTime) {
                    alert('Please select both start and end dates');
                    return;
                }
            } else {
                const now = new Date();
                endTime = now.toISOString();
                
                switch(timeRange) {
                    case '1h':
                        startTime = new Date(now - 60 * 60 * 1000).toISOString();
                        break;
                    case '24h':
                        startTime = new Date(now - 24 * 60 * 60 * 1000).toISOString();
                        break;
                    case '7d':
                        startTime = new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString();
                        break;
                    case '30d':
                        startTime = new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString();
                        break;
                }
            }

            // Show loading state
            const summarizeBtn = document.querySelector('button[onclick="summarizeChannel()"]');
            const originalText = summarizeBtn.innerHTML;
            summarizeBtn.innerHTML = `
                <i data-feather="loader" class="h-4 w-4 animate-spin"></i>
                Summarizing...
            `;
            feather.replace();

            // Call summarize API
            fetch(`/api/channels/${currentChannelId}/summarize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    startTime,
                    endTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const summaryContainer = document.getElementById('summaryContainer');
                    const summaryContent = document.getElementById('summaryContent');
                    
                    // Show the summary container
                    summaryContainer.classList.remove('hidden');
                    
                    // Format and display the summary
                    summaryContent.innerHTML = data.summary.split('\n').map(line => 
                        `<p class="mb-2">${line}</p>`
                    ).join('');
                    
                    // Show save/dismiss options
                    const saveOptions = document.getElementById('saveSummaryOptions');
                    saveOptions.classList.remove('hidden');
                    // Store summary and metadata for saving
                    saveOptions.dataset.summary = data.markdown_summary;
                    saveOptions.dataset.html = data.summary;
                    saveOptions.dataset.startTime = startTime;
                    saveOptions.dataset.endTime = endTime;
                    saveOptions.dataset.channelId = currentChannelId;
                    // Scroll the summary into view
                    summaryContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    feather.replace();
                } else {
                    alert('Failed to generate summary: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error generating summary: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                summarizeBtn.innerHTML = originalText;
                feather.replace();
            });
        }

        // Copy summary to clipboard
        function copySummary() {
            const summaryContent = document.getElementById('summaryContent');
            const text = summaryContent.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('button[onclick="copySummary()"]');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <i data-feather="check" class="h-4 w-4"></i>
                    Copied!
                `;
                feather.replace();
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    feather.replace();
                }, 2000);
            });
        }

        function updateAllOutlookAuthStatuses() {
            const outlookChannelIds = JSON.parse(document.getElementById('outlook-channel-ids').textContent);
            outlookChannelIds.forEach(function(channelId) {
                fetch('/api/outlook/auth-status')
                    .then(r => r.json())
                    .then(data => {
                        const el = document.getElementById('auth-status-' + channelId);
                        const btn = document.getElementById('auth-btn-' + channelId);
                        if (!el) return;
                        let dot, statusText;
                        if (data.success) {
                            if (data.authenticated) {
                                dot = '<span class="inline-block w-2 h-2 rounded-full bg-green-500 align-middle"></span>';
                                statusText = 'Authenticated';
                                if (btn) btn.classList.add('hidden');
                            } else {
                                dot = '<span class="inline-block w-2 h-2 rounded-full bg-red-500 align-middle"></span>';
                                statusText = 'Not Authenticated';
                                if (btn) btn.classList.remove('hidden');
                            }
                        } else {
                            dot = '<span class="inline-block w-2 h-2 rounded-full bg-yellow-400 align-middle"></span>';
                            statusText = 'Error checking auth';
                            if (btn) btn.classList.remove('hidden');
                        }
                        el.innerHTML = dot;
                        el.title = statusText;
                    })
                    .catch(() => {
                        const el = document.getElementById('auth-status-' + channelId);
                        const btn = document.getElementById('auth-btn-' + channelId);
                        if (el) {
                            el.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-yellow-400 align-middle"></span>';
                            el.title = 'Error checking auth';
                        }
                        if (btn) btn.classList.remove('hidden');
                    });
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            updateAllOutlookAuthStatuses();
            loadActionItems();
        });

        function authenticateOutlook(event, channelId) {
            event.stopPropagation();
            const btn = document.getElementById('auth-btn-' + channelId);
            btn.disabled = true;
            btn.textContent = 'Loading...';
            fetch('/api/outlook/authenticate', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.auth_link) {
                        const popup = window.open(data.auth_link, '_blank');
                        if (popup) {
                            const pollTimer = setInterval(function() {
                                if (popup.closed) {
                                    clearInterval(pollTimer);
                                    // Update status for all Outlook channels
                                    updateAllOutlookAuthStatuses();
                                }
                            }, 500);
                        }
                    } else {
                        alert('Failed to get authentication link.');
                    }
                })
                .catch(() => {
                    alert('Failed to get authentication link.');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Authenticate';
                });
        }

        // Load action items from the API
        function loadActionItems() {
            fetch('/api/action-items')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('actionItemsContainer');
                    
                    if (data.success && data.action_items) {
                        displayActionItems(data.action_items);
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <i data-feather="alert-circle" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                                <p class="text-gray-500 mb-2">No action items found</p>
                                <p class="text-sm text-gray-400">Run the action generation script to create action items from meeting summaries</p>
                            </div>
                        `;
                        feather.replace();
                    }
                })
                .catch(error => {
                    const container = document.getElementById('actionItemsContainer');
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i data-feather="alert-triangle" class="h-12 w-12 text-red-400 mx-auto mb-4"></i>
                            <p class="text-red-500 mb-2">Error loading action items</p>
                            <p class="text-sm text-gray-400">${error.message}</p>
                        </div>
                    `;
                    feather.replace();
                });
        }

        // Display action items in the container
        function displayActionItems(actionItems) {
            const container = document.getElementById('actionItemsContainer');
            
            if (Object.keys(actionItems).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i data-feather="inbox" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-500">No action items available</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            // Group all actions by client (assuming all are from one client for now)
            const clientName = "TechCorp Solutions";
            let allActions = [];
            let totalActions = 0;
            
            for (const [summaryFile, actions] of Object.entries(actionItems)) {
                actions.forEach(action => {
                    allActions.push({
                        ...action,
                        sourceFile: summaryFile
                    });
                });
                totalActions += actions.length;
            }

            // Create client-organized view
            let html = `
                <div class="border rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${clientName}</h3>
                            <p class="text-gray-600 mt-1">All action items from meeting summaries and Slack conversations</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full font-medium">
                                ${totalActions} total actions
                            </span>
                            <button onclick="toggleAllActions()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200 flex items-center gap-1">
                                <i data-feather="chevron-down" class="h-4 w-4" id="all-actions-chevron"></i>
                                Toggle All
                            </button>
                        </div>
                    </div>
                    
                    <div id="all-actions-content" class="hidden">
                        <div class="space-y-6">
            `;
            
            // Group actions by source file
            const actionsBySource = {};
            allActions.forEach(action => {
                if (!actionsBySource[action.sourceFile]) {
                    actionsBySource[action.sourceFile] = [];
                }
                actionsBySource[action.sourceFile].push(action);
            });
            
            for (const [sourceFile, actions] of Object.entries(actionsBySource)) {
                html += `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-medium text-gray-900">${sourceFile.replace('.md', '').replace('.txt', '')}</h4>
                            <span class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded-full">${actions.length} actions</span>
                        </div>
                        <div class="space-y-3">
                `;
                
                actions.forEach((action, index) => {
                    html += `
                        <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">
                                    ${index + 1}
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900 mb-2">${action.action}</h5>
                                    <p class="text-sm text-gray-600 mb-3">${action.reasoning}</p>
                                    <button onclick="takeAction('${action.action.replace(/'/g, "\\'")}', '${sourceFile}')" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 flex items-center gap-2">
                                        <i data-feather="mail" class="h-4 w-4"></i>
                                        Take Action
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            feather.replace();
        }

        // Toggle all actions visibility
        function toggleAllActions() {
            const contentDiv = document.getElementById('all-actions-content');
            const chevron = document.getElementById('all-actions-chevron');
            
            if (contentDiv.classList.contains('hidden')) {
                contentDiv.classList.remove('hidden');
                chevron.setAttribute('data-feather', 'chevron-up');
            } else {
                contentDiv.classList.add('hidden');
                chevron.setAttribute('data-feather', 'chevron-down');
            }
            feather.replace();
        }

        // Refresh action items
        function refreshActionItems() {
            const container = document.getElementById('actionItemsContainer');
            container.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <i data-feather="loader" class="h-8 w-8 text-gray-400 mx-auto mb-2 animate-spin"></i>
                        <p class="text-gray-500">Refreshing action items...</p>
                    </div>
                </div>
            `;
            feather.replace();

            fetch('/api/refresh-action-items', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Failed to refresh action items: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error refreshing action items: ' + error.message);
                })
                .finally(() => {
                    loadActionItems();
                });
        }

        // Take action function - opens email dialog
        function takeAction(actionText, summaryFile) {
            const dialog = document.getElementById('emailActionDialog');
            const actionDisplay = document.getElementById('actionItemDisplay');
            const subjectField = document.getElementById('emailSubject');
            const messageField = document.getElementById('emailMessage');
            
            // Display the action item
            actionDisplay.textContent = actionText;
            
            // Pre-fill subject and message
            subjectField.value = `Action Item: ${actionText.substring(0, 50)}${actionText.length > 50 ? '...' : ''}`;
            
            const defaultMessage = `Hi,

I'm following up on the action item from our recent meeting:

${actionText}

Please let me know if you need any clarification or have questions about this action item.

Best regards,
[Your Name]`;
            
            messageField.value = defaultMessage;
            
            // Show the dialog
            dialog.classList.remove('hidden');
            feather.replace();
        }

        // Close email action dialog
        function closeEmailActionDialog() {
            const dialog = document.getElementById('emailActionDialog');
            dialog.classList.add('hidden');
            
            // Clear the form
            document.getElementById('emailTo').value = '';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailMessage').value = '';
            document.getElementById('actionItemDisplay').textContent = '';
        }

        // Send action email
        function sendActionEmail() {
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const action = document.getElementById('actionItemDisplay').textContent;
            
            if (!to || !subject || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            // Show loading state
            const sendBtn = document.querySelector('button[onclick="sendActionEmail()"]');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = `
                <i data-feather="loader" class="h-4 w-4 mr-2 animate-spin"></i>
                Sending...
            `;
            sendBtn.disabled = true;
            feather.replace();
            
            // Send email via API
            fetch('/api/send-action-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: to,
                    subject: subject,
                    message: message,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Email sent successfully!');
                    closeEmailActionDialog();
                } else if (response.status === 401 && data.auth_url) {
                    // Authentication required
                    const authConfirmed = confirm('Outlook authentication required. Would you like to authenticate now?');
                    if (authConfirmed) {
                        window.open(data.auth_url, '_blank');
                        alert('Please complete the authentication in the new window, then try sending the email again.');
                    }
                } else {
                    alert('Failed to send email: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error sending email: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
                feather.replace();
            });
        }

        // Load client-organized action items from the API
        function loadClientActionItems() {
            fetch('/api/action-items-by-client')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('clientActionItemsContainer');
                    
                    if (data.success && data.action_items) {
                        displayClientActionItems(data.action_items);
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <i data-feather="alert-circle" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                                <p class="text-gray-500 mb-2">No client action items found</p>
                                <p class="text-sm text-gray-400">Run the client-organized action generation script to create action items by client</p>
                            </div>
                        `;
                        feather.replace();
                    }
                })
                .catch(error => {
                    const container = document.getElementById('clientActionItemsContainer');
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i data-feather="alert-triangle" class="h-12 w-12 text-red-400 mx-auto mb-4"></i>
                            <p class="text-red-500 mb-2">Error loading client action items</p>
                            <p class="text-sm text-gray-400">${error.message}</p>
                        </div>
                    `;
                    feather.replace();
                });
        }

        // Display client-organized action items with burger menu structure
        function displayClientActionItems(clientActionItems) {
            const container = document.getElementById('clientActionItemsContainer');
            
            if (Object.keys(clientActionItems).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i data-feather="inbox" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-500">No client action items available</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            let html = '';
            
            for (const [clientName, clientData] of Object.entries(clientActionItems)) {
                const info = clientData.client_info;
                const categories = clientData.categories;
                
                html += `
                    <div class="border rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${clientName}</h3>
                                <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                    <span class="flex items-center gap-1">
                                        <i data-feather="list" class="h-4 w-4"></i>
                                        ${info.total_actions} total
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                        ${info.high_priority} high
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                                        ${info.medium_priority} medium
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                        ${info.low_priority} low
                                    </span>
                                </div>
                            </div>
                            <button onclick="toggleClientActions('${clientName.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-md text-sm hover:bg-purple-200 flex items-center gap-1">
                                <i data-feather="chevron-down" class="h-4 w-4" id="chevron-${clientName.replace(/\s+/g, '-')}"></i>
                                Toggle
                            </button>
                        </div>
                        
                        <div id="client-actions-${clientName.replace(/\s+/g, '-')}" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                // Display actions by category
                for (const [categoryName, actions] of Object.entries(categories)) {
                    if (actions.length > 0) {
                        html += `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-feather="${getCategoryIcon(categoryName)}" class="h-4 w-4 text-purple-600"></i>
                                    <h4 class="font-medium text-gray-900 capitalize">${categoryName}</h4>
                                    <span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">${actions.length}</span>
                                </div>
                                <div class="space-y-3">
                        `;
                        
                        actions.forEach((action, index) => {
                            const priorityColor = getPriorityColor(action.priority);
                            html += `
                                <div class="bg-white rounded-md p-3 border-l-4 ${priorityColor.border}">
                                    <div class="flex items-start gap-2">
                                        <span class="px-2 py-1 text-xs ${priorityColor.bg} ${priorityColor.text} rounded-full font-medium">
                                            ${action.priority}
                                        </span>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-900 mb-1">${action.action}</p>
                                            <p class="text-xs text-gray-600 mb-2">${action.reasoning}</p>
                                            <button onclick="takeAction('${action.action.replace(/'/g, "\\'")}', '${clientName}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 flex items-center gap-1">
                                                <i data-feather="mail" class="h-3 w-3"></i>
                                                Take Action
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            feather.replace();
        }

        // Toggle client actions visibility
        function toggleClientActions(clientName) {
            const actionsDiv = document.getElementById(`client-actions-${clientName.replace(/\s+/g, '-')}`);
            const chevron = document.getElementById(`chevron-${clientName.replace(/\s+/g, '-')}`);
            
            if (actionsDiv.classList.contains('hidden')) {
                actionsDiv.classList.remove('hidden');
                chevron.setAttribute('data-feather', 'chevron-up');
            } else {
                actionsDiv.classList.add('hidden');
                chevron.setAttribute('data-feather', 'chevron-down');
            }
            feather.replace();
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'support': 'help-circle',
                'training': 'book-open',
                'documentation': 'file-text',
                'design': 'edit-3',
                'communication': 'message-circle'
            };
            return icons[category] || 'circle';
        }

        // Get priority color classes
        function getPriorityColor(priority) {
            const colors = {
                'high': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-500' },
                'medium': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-500' },
                'low': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500' }
            };
            return colors[priority.toLowerCase()] || colors.medium;
        }

        // Refresh client action items
        function refreshClientActionItems() {
            const container = document.getElementById('clientActionItemsContainer');
            container.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <i data-feather="loader" class="h-8 w-8 text-gray-400 mx-auto mb-2 animate-spin"></i>
                        <p class="text-gray-500">Refreshing client action items...</p>
                    </div>
                </div>
            `;
            feather.replace();

            fetch('/api/refresh-action-items', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Failed to refresh client action items: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error refreshing client action items: ' + error.message);
                })
                .finally(() => {
                    loadClientActionItems();
                });
        }

        // Update the window load event to also load client action items
        window.addEventListener('DOMContentLoaded', function() {
            updateAllOutlookAuthStatuses();
            loadActionItems();
            loadClientActionItems();
        });

        // Add event listeners for save/dismiss buttons
        if (!window._saveSummaryListenersAdded) {
            document.addEventListener('DOMContentLoaded', function() {
                const saveBtn = document.getElementById('saveSummaryBtn');
                const dismissBtn = document.getElementById('dismissSummaryBtn');
                if (saveBtn && dismissBtn) {
                    saveBtn.addEventListener('click', function() {
                        const saveOptions = document.getElementById('saveSummaryOptions');
                        const summary = saveOptions.dataset.summary;
                        const html = saveOptions.dataset.html;
                        const startTime = saveOptions.dataset.startTime;
                        const endTime = saveOptions.dataset.endTime;
                        const channelId = saveOptions.dataset.channelId;
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i data-feather="loader" class="h-4 w-4 animate-spin"></i> Saving...';
                        fetch('/api/save-summary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                channelId,
                                startTime,
                                endTime,
                                summary,
                                html
                            })
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                saveBtn.innerHTML = '<i data-feather="check" class="h-4 w-4"></i> Saved!';
                                setTimeout(() => {
                                    document.getElementById('saveSummaryOptions').classList.add('hidden');
                                    saveBtn.innerHTML = '<i data-feather="save" class="h-4 w-4"></i> Save Summary for Action Generation';
                                    saveBtn.disabled = false;
                                    feather.replace();
                                }, 1500);
                            } else {
                                saveBtn.innerHTML = '<i data-feather="alert-circle" class="h-4 w-4"></i> Error';
                                saveBtn.disabled = false;
                                feather.replace();
                            }
                        })
                        .catch(() => {
                            saveBtn.innerHTML = '<i data-feather="alert-circle" class="h-4 w-4"></i> Error';
                            saveBtn.disabled = false;
                            feather.replace();
                        });
                    });
                    dismissBtn.addEventListener('click', function() {
                        document.getElementById('saveSummaryOptions').classList.add('hidden');
                    });
                }
                window._saveSummaryListenersAdded = true;
            });
        }
    </script>
</body>
</html> 